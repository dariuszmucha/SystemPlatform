/*
 * n5110_therm_display.c
 *
 * Created: 31/01/2016 17:40:00
 *  Author: dariusz.mucha
 */ 

#include "n5110_therm_display.h"
#include "libn5110.h"
#include "libdht11.h"
#include <avr/pgmspace.h>

#define N5110_ROWS			N5110_PIXEL_HEIGHT / 8
#define N5110_COLUMNS		N5110_PIXEL_WIDTH

#define N5110_FONT_HEIGHT   3
#define N5110_FONT_WIDTH	14

static uint8_t n5110_buffer[N5110_ROWS * N5110_COLUMNS];

static const uint8_t n5110_numbers[10][42] = {
/*0*/{0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFF, 0x03, 0x01, 0x01, 0x01, 0x01, 0x07, 0xFE, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x0C, 0x0C, 0x0C, 0x0C, 0x06, 0x07, 0x01, 0x00, 0x00},
/*1*/{0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x06, 0x07, 0x07, 0x06, 0x06, 0x06, 0x00, 0x00, 0x00},
/*2*/{0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x81, 0xC0, 0xC0, 0x60, 0x30, 0x39, 0x1F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x06, 0x07, 0x07, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x00, 0x00},
/*3*/{0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x18, 0x18, 0x18, 0x3D, 0xFF, 0xE7, 0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0x06, 0x06, 0x06, 0x06, 0x06, 0x07, 0x03, 0x01, 0x00, 0x00},
/*4*/{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0xFC, 0xCE, 0xC7, 0xC1, 0xFF, 0xFF, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x07, 0x07, 0x06, 0x00, 0x00, 0x00},
/*5*/{0x00, 0x00, 0x00, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x1F, 0x08, 0x0C, 0x0C, 0x0C, 0x1C, 0xF8, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x06, 0x06, 0x06, 0x06, 0x06, 0x07, 0x03, 0x01, 0x00, 0x00},
/*6*/{0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFF, 0x37, 0x19, 0x19, 0x18, 0x38, 0xF0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x06, 0x06, 0x06, 0x07, 0x03, 0x01, 0x00, 0x00, 0x00},
/*7*/{0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x01, 0x01, 0x01, 0xC1, 0xFD, 0x3F, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x0F, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00},
/*8*/{0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xCE, 0xFF, 0x7B, 0x31, 0x31, 0x31, 0x31, 0x7B, 0xFF, 0xCE, 0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0E, 0x07, 0x03, 0x00, 0x00},
/*9*/{0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E, 0x3F, 0x73, 0x61, 0x61, 0x61, 0xB3, 0xFF, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x0C, 0x0C, 0x0E, 0x06, 0x07, 0x03, 0x00, 0x00, 0x00, 0x00}
};

static const uint8_t n5110_symbols[3][42] = {
/*degree*/{0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xC0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0F, 0x18, 0x18, 0x18, 0x0F, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	 /*C*/{0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0xFF, 0x81, 0x00, 0x00, 0x00, 0x00, 0x00, 0x81, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00},
	 /*%*/{0x80, 0xC0, 0x40, 0x40, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x80, 0xC0, 0x40, 0x00, 0x00, 0x07, 0x0F, 0x08, 0x88, 0xCF, 0x67, 0x38, 0x1C, 0xE6, 0xF3, 0x11, 0x10, 0xF0, 0xE0, 0x00, 0x00, 0x02, 0x03, 0x01, 0x00, 0x00, 0x00, 0x01, 0x03, 0x02, 0x02, 0x03, 0x01}
};

static void n5110_draw(const uint8_t* data, const uint8_t* position)
{
	uint8_t i, j;
	for(i = 0; i < N5110_FONT_HEIGHT; i++)
	{
		for(j = 0; j < N5110_FONT_WIDTH; j++)
		{
			n5110_buffer[ (position[1] * N5110_FONT_HEIGHT + i)*N5110_PIXEL_WIDTH + position[0] * N5110_FONT_WIDTH + j ] = data[j + (i * N5110_FONT_WIDTH)];
		}
	}
}

void n5110_therm_display_temp(uint8_t temperature)
{
	uint8_t digits[2];
	uint8_t position[2] = {1,0};
	digits[0] = temperature / 10;
	digits[1] = temperature % 10;
	
	dht11_update();
	
	n5110_draw(n5110_numbers[digits[0]], position); 
	position[0]++;
	n5110_draw(n5110_numbers[digits[1]], position);
	position[0]++;
	n5110_draw(n5110_symbols[0], position);
	position[0]++;
	n5110_draw(n5110_symbols[1], position);

	N5110_Transfer_Buf((const uint8_t*)n5110_buffer, N5110_ROWS * N5110_PIXEL_WIDTH);
}

void n5110_therm_display_humid(uint8_t humidity)
{ 
	uint8_t digits[2];
	uint8_t position[2] = {1,1};
	digits[0] = humidity / 10;
	digits[1] = humidity % 10;
	
	n5110_draw(n5110_numbers[digits[0]], position);
	position[0]++;
	n5110_draw(n5110_numbers[digits[1]], position);
	position[0]++;
	n5110_draw(n5110_symbols[2], position);
		
	N5110_Transfer_Buf((const uint8_t*)n5110_buffer, N5110_ROWS * N5110_PIXEL_WIDTH);
}

void n5110_therm_init(void)
{
	N5110_Init();	
}
